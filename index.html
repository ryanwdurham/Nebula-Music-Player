<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nebula Music Player</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    .progress-thumb { opacity: 0; transition: opacity 0.2s; }
    .progress-bar:hover .progress-thumb { opacity: 1; }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #a855f7;
      cursor: pointer;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-950 via-purple-950 to-slate-950">
  <div id="app" class="min-h-screen text-white p-8 flex items-center justify-center"></div>

  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>

  <script>
    const { createElement: h, useState, useRef, useEffect } = React;
    
    const themes = {
      nebula: { from: 'from-slate-950', via: 'via-purple-950', to: 'to-slate-950', accent: 'purple', name: 'Nebula' },
      cyberpunk: { from: 'from-pink-950', via: 'via-cyan-950', to: 'to-purple-950', accent: 'cyan', name: 'Cyberpunk' },
      ocean: { from: 'from-blue-950', via: 'via-teal-950', to: 'to-cyan-950', accent: 'teal', name: 'Ocean Wave' },
      sunset: { from: 'from-orange-950', via: 'via-red-950', to: 'to-pink-950', accent: 'orange', name: 'Sunset' },
      matrix: { from: 'from-green-950', via: 'via-emerald-950', to: 'to-lime-950', accent: 'green', name: 'Matrix' },
      royal: { from: 'from-indigo-950', via: 'via-purple-950', to: 'to-violet-950', accent: 'indigo', name: 'Royal' },
      fire: { from: 'from-red-950', via: 'via-orange-950', to: 'to-yellow-950', accent: 'red', name: 'Fire' },
      midnight: { from: 'from-slate-950', via: 'via-blue-950', to: 'to-indigo-950', accent: 'blue', name: 'Midnight' },
      rose: { from: 'from-pink-950', via: 'via-rose-950', to: 'to-red-950', accent: 'rose', name: 'Rose Gold' },
      arctic: { from: 'from-cyan-950', via: 'via-blue-950', to: 'to-slate-950', accent: 'cyan', name: 'Arctic' }
    };

    const icons = {
      Play: () => h('svg', { width: 32, height: 32, viewBox: '0 0 24 24', fill: 'currentColor' },
        h('path', { d: 'M8 5v14l11-7z' })),
      Pause: () => h('svg', { width: 32, height: 32, viewBox: '0 0 24 24', fill: 'currentColor' },
        h('path', { d: 'M6 4h4v16H6V4zm8 0h4v16h-4V4z' })),
      SkipForward: () => h('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        h('path', { d: 'M5 4l10 8-10 8V4zM19 5v14' })),
      SkipBack: () => h('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        h('path', { d: 'M19 20L9 12l10-8v16zM5 19V5' })),
      Volume2: () => h('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        h('path', { d: 'M11 5L6 9H2v6h4l5 4V5zM19.07 4.93a10 10 0 010 14.14M15.54 8.46a5 5 0 010 7.07' })),
      VolumeX: () => h('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        h('path', { d: 'M11 5L6 9H2v6h4l5 4V5zM23 9l-6 6M17 9l6 6' })),
      List: () => h('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        h('path', { d: 'M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01' })),
      Plus: () => h('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        h('path', { d: 'M12 5v14M5 12h14' })),
      Shuffle: () => h('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        h('path', { d: 'M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l6 6M4 4l5 5' })),
      Repeat: () => h('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        h('path', { d: 'M17 1l4 4-4 4M3 11V9a4 4 0 014-4h14M7 23l-4-4 4-4M21 13v2a4 4 0 01-4 4H3' })),
      Palette: () => h('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
        h('path', { d: 'M12 2a10 10 0 0 0-9.95 9h11.64L9.74 7.05a1 1 0 0 1 1.41-1.41l5.66 5.65a1 1 0 0 1 0 1.42l-5.66 5.65a1 1 0 0 1-1.41 0 1 1 0 0 1 0-1.41L13.69 13H2.05A10 10 0 1 0 12 2z' }))
    };

    function NebulaMusicPlayer() {
      const [playlist, setPlaylist] = useState([]);
      const [currentTrack, setCurrentTrack] = useState(null);
      const [isPlaying, setIsPlaying] = useState(false);
      const [currentTime, setCurrentTime] = useState(0);
      const [duration, setDuration] = useState(0);
      const [volume, setVolume] = useState(0.7);
      const [isMuted, setIsMuted] = useState(false);
      const [showPlaylist, setShowPlaylist] = useState(true);
      const [shuffle, setShuffle] = useState(false);
      const [repeat, setRepeat] = useState(false);
      const [theme, setTheme] = useState('nebula');
      const [showThemes, setShowThemes] = useState(false);
      
      const audioRef = useRef(null);
      const nextAudioRef = useRef(null);
      const fileInputRef = useRef(null);
      const isCrossfading = useRef(false);
      const fadeIntervalRef = useRef(null);

      useEffect(() => {
        document.body.className = `bg-gradient-to-br ${themes[theme].from} ${themes[theme].via} ${themes[theme].to}`;
      }, [theme]);

      useEffect(() => {
        const audio = audioRef.current;
        if (!audio) return;

        const updateTime = () => {
          setCurrentTime(audio.currentTime);
          
          // Start crossfade 10 seconds before end
          if (!isCrossfading.current && !repeat && duration > 10 && (duration - audio.currentTime) <= 10 && (duration - audio.currentTime) > 9.9) {
            startCrossfade();
          }
        };
        
        const updateDuration = () => setDuration(audio.duration);
        
        const handleEnded = () => {
          if (repeat && !isCrossfading.current) {
            audio.currentTime = 0;
            audio.play();
          } else if (!isCrossfading.current) {
            handleNext();
          }
        };

        audio.addEventListener('timeupdate', updateTime);
        audio.addEventListener('loadedmetadata', updateDuration);
        audio.addEventListener('ended', handleEnded);

        return () => {
          audio.removeEventListener('timeupdate', updateTime);
          audio.removeEventListener('loadedmetadata', updateDuration);
          audio.removeEventListener('ended', handleEnded);
        };
      }, [duration, repeat, currentTrack, playlist, shuffle]);

      const startCrossfade = () => {
        if (isCrossfading.current || repeat || playlist.length <= 1) return;
        
        const next = getNextTrack();
        if (!next) return;

        console.log('Starting crossfade to:', next.name);
        isCrossfading.current = true;

        const currentAudio = audioRef.current;
        const nextAudio = nextAudioRef.current;
        
        nextAudio.src = next.url;
        nextAudio.volume = 0;
        nextAudio.play().catch(e => console.error('Next audio play error:', e));

        let step = 0;
        const totalSteps = 100; // 10 seconds at 100ms intervals

        if (fadeIntervalRef.current) {
          clearInterval(fadeIntervalRef.current);
        }

        fadeIntervalRef.current = setInterval(() => {
          step++;
          const progress = step / totalSteps;
          
          currentAudio.volume = Math.max(0, volume * (1 - progress));
          nextAudio.volume = Math.min(volume, volume * progress);

          if (step >= totalSteps) {
            clearInterval(fadeIntervalRef.current);
            fadeIntervalRef.current = null;
            
            currentAudio.pause();
            currentAudio.src = next.url;
            currentAudio.currentTime = nextAudio.currentTime;
            currentAudio.volume = volume;
            currentAudio.play().catch(e => console.error('Audio play error:', e));
            
            nextAudio.pause();
            nextAudio.currentTime = 0;
            nextAudio.src = '';
            
            setCurrentTrack(next);
            isCrossfading.current = false;
            console.log('Crossfade complete');
          }
        }, 100);
      };

      const getNextTrack = () => {
        if (playlist.length === 0) return null;
        const currentIdx = playlist.findIndex(t => t.id === currentTrack?.id);
        let nextIdx;
        if (shuffle) {
          nextIdx = Math.floor(Math.random() * playlist.length);
        } else {
          nextIdx = (currentIdx + 1) % playlist.length;
        }
        return playlist[nextIdx];
      };

      const handleFileUpload = (e) => {
        const files = Array.from(e.target.files);
        const newTracks = files.map((file, idx) => ({
          id: Date.now() + idx,
          name: file.name.replace(/\.[^/.]+$/, ''),
          file: file,
          url: URL.createObjectURL(file)
        }));
        setPlaylist([...playlist, ...newTracks]);
        if (!currentTrack && newTracks.length > 0) {
          setCurrentTrack(newTracks[0]);
        }
      };

      const playTrack = (track) => {
        if (fadeIntervalRef.current) {
          clearInterval(fadeIntervalRef.current);
          fadeIntervalRef.current = null;
        }
        isCrossfading.current = false;
        nextAudioRef.current.pause();
        nextAudioRef.current.src = '';
        
        setCurrentTrack(track);
        setIsPlaying(true);
        setTimeout(() => {
          audioRef.current.volume = volume;
          audioRef.current?.play();
        }, 0);
      };

      const togglePlay = () => {
        if (!currentTrack) return;
        if (isPlaying) {
          audioRef.current?.pause();
        } else {
          audioRef.current?.play();
        }
        setIsPlaying(!isPlaying);
      };

      const handleNext = () => {
        if (playlist.length === 0) return;
        const next = getNextTrack();
        if (next) playTrack(next);
      };

      const handlePrev = () => {
        if (playlist.length === 0) return;
        const currentIdx = playlist.findIndex(t => t.id === currentTrack?.id);
        const prevIdx = currentIdx <= 0 ? playlist.length - 1 : currentIdx - 1;
        playTrack(playlist[prevIdx]);
      };

      const handleSeek = (e) => {
        const rect = e.currentTarget.getBoundingClientRect();
        const percent = (e.clientX - rect.left) / rect.width;
        const newTime = percent * duration;
        audioRef.current.currentTime = newTime;
        setCurrentTime(newTime);
      };

      const handleVolumeChange = (e) => {
        const newVolume = parseFloat(e.target.value);
        setVolume(newVolume);
        audioRef.current.volume = newVolume;
        setIsMuted(newVolume === 0);
      };

      const toggleMute = () => {
        if (isMuted) {
          audioRef.current.volume = volume;
          setIsMuted(false);
        } else {
          audioRef.current.volume = 0;
          setIsMuted(true);
        }
      };

      const formatTime = (seconds) => {
        if (!seconds || isNaN(seconds)) return '0:00';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      };

      const accentColor = themes[theme].accent;

      return h('div', { className: 'w-full max-w-6xl' },
        h('div', { className: 'backdrop-blur-xl bg-black/40 rounded-3xl shadow-2xl border border-purple-500/20 overflow-hidden' },
          h('div', { className: `bg-gradient-to-r from-${accentColor}-900/50 to-pink-900/50 p-6 border-b border-${accentColor}-500/30` },
            h('div', { className: 'flex items-center justify-between' },
              h('h1', { className: `text-3xl font-bold bg-gradient-to-r from-${accentColor}-400 to-pink-400 bg-clip-text text-transparent` }, 'NEBULA'),
              h('div', { className: 'flex gap-3' },
                h('div', { className: 'relative' },
                  h('button', {
                    onClick: () => setShowThemes(!showThemes),
                    className: `p-2 rounded-lg bg-${accentColor}-500/20 hover:bg-${accentColor}-500/40 transition-all`
                  }, h(icons.Palette)),
                  showThemes && h('div', { className: 'absolute top-12 right-0 bg-black/90 backdrop-blur-xl rounded-xl p-3 border border-purple-500/30 z-50 min-w-[160px]' },
                    Object.entries(themes).map(([key, t]) =>
                      h('button', {
                        key: key,
                        onClick: () => { setTheme(key); setShowThemes(false); },
                        className: `w-full text-left px-3 py-2 rounded-lg hover:bg-${t.accent}-500/20 transition-all ${theme === key ? `bg-${t.accent}-500/30` : ''}`
                      }, t.name)
                    )
                  )
                ),
                h('button', {
                  onClick: () => setShowPlaylist(!showPlaylist),
                  className: `p-2 rounded-lg bg-${accentColor}-500/20 hover:bg-${accentColor}-500/40 transition-all`
                }, h(icons.List)),
                h('button', {
                  onClick: () => fileInputRef.current?.click(),
                  className: `px-4 py-2 rounded-lg bg-gradient-to-r from-${accentColor}-600 to-pink-600 hover:from-${accentColor}-500 hover:to-pink-500 transition-all flex items-center gap-2`
                }, h(icons.Plus), ' Add Music')
              )
            )
          ),
          h('div', { className: 'flex' },
            h('div', { className: `${showPlaylist ? 'w-2/3' : 'w-full'} p-8` },
              h('div', { className: 'relative mb-8' },
                h('div', { className: `w-full aspect-square max-w-md mx-auto rounded-2xl bg-gradient-to-br from-${accentColor}-600/30 to-pink-600/30 border border-${accentColor}-500/30 flex items-center justify-center overflow-hidden` },
                  currentTrack ? h('div', { className: 'text-center p-8' },
                    h('div', { className: `w-32 h-32 mx-auto mb-4 rounded-full bg-gradient-to-br from-${accentColor}-500 to-pink-500 animate-pulse` }),
                    h('h2', { className: 'text-2xl font-bold mb-2' }, currentTrack.name),
                    h('p', { className: `text-${accentColor}-300` }, 'Unknown Artist')
                  ) : h('div', { className: `text-center text-${accentColor}-300` },
                    h('p', { className: 'text-lg' }, 'No track selected'),
                    h('p', { className: 'text-sm mt-2' }, 'Add music to get started')
                  )
                )
              ),
              h('div', { className: 'mb-6' },
                h('div', {
                  onClick: handleSeek,
                  className: `h-2 bg-${accentColor}-900/50 rounded-full cursor-pointer group progress-bar`
                },
                  h('div', {
                    className: `h-full bg-gradient-to-r from-${accentColor}-500 to-pink-500 rounded-full relative group-hover:h-3 transition-all`,
                    style: { width: `${(currentTime / duration) * 100 || 0}%` }
                  },
                    h('div', { className: 'absolute right-0 top-1/2 -translate-y-1/2 w-4 h-4 bg-white rounded-full shadow-lg progress-thumb' })
                  )
                ),
                h('div', { className: `flex justify-between text-sm text-${accentColor}-300 mt-2` },
                  h('span', {}, formatTime(currentTime)),
                  h('span', {}, formatTime(duration))
                )
              ),
              h('div', { className: 'flex items-center justify-center gap-4 mb-6' },
                h('button', {
                  onClick: () => setShuffle(!shuffle),
                  className: `p-3 rounded-lg transition-all ${shuffle ? `bg-${accentColor}-500/40 text-white` : `bg-${accentColor}-500/10 text-${accentColor}-300 hover:bg-${accentColor}-500/20`}`
                }, h(icons.Shuffle)),
                h('button', {
                  onClick: handlePrev,
                  className: `p-4 rounded-full bg-${accentColor}-500/20 hover:bg-${accentColor}-500/40 transition-all`
                }, h(icons.SkipBack)),
                h('button', {
                  onClick: togglePlay,
                  className: `p-6 rounded-full bg-gradient-to-r from-${accentColor}-600 to-pink-600 hover:from-${accentColor}-500 hover:to-pink-500 transition-all shadow-lg shadow-${accentColor}-500/50`
                }, isPlaying ? h(icons.Pause) : h(icons.Play)),
                h('button', {
                  onClick: handleNext,
                  className: `p-4 rounded-full bg-${accentColor}-500/20 hover:bg-${accentColor}-500/40 transition-all`
                }, h(icons.SkipForward)),
                h('button', {
                  onClick: () => setRepeat(!repeat),
                  className: `p-3 rounded-lg transition-all ${repeat ? `bg-${accentColor}-500/40 text-white` : `bg-${accentColor}-500/10 text-${accentColor}-300 hover:bg-${accentColor}-500/20`}`
                }, h(icons.Repeat))
              ),
              h('div', { className: 'flex items-center gap-4 max-w-xs mx-auto' },
                h('button', {
                  onClick: toggleMute,
                  className: `text-${accentColor}-300 hover:text-white transition-colors`
                }, isMuted ? h(icons.VolumeX) : h(icons.Volume2)),
                h('input', {
                  type: 'range',
                  min: '0',
                  max: '1',
                  step: '0.01',
                  value: isMuted ? 0 : volume,
                  onChange: handleVolumeChange,
                  className: `flex-1 h-1 bg-${accentColor}-900/50 rounded-full cursor-pointer`
                })
              )
            ),
            showPlaylist && h('div', { className: `w-1/3 bg-black/40 border-l border-${accentColor}-500/30 p-6 max-h-[600px] overflow-y-auto` },
              h('h3', { className: `text-xl font-bold mb-4 text-${accentColor}-300` }, 'Playlist'),
              playlist.length === 0
                ? h('p', { className: `text-${accentColor}-300/50 text-center mt-8` }, 'No tracks yet')
                : h('div', { className: 'space-y-2' },
                    playlist.map(track =>
                      h('div', {
                        key: track.id,
                        onClick: () => playTrack(track),
                        className: `p-3 rounded-lg cursor-pointer transition-all ${
                          currentTrack?.id === track.id
                            ? `bg-gradient-to-r from-${accentColor}-600/40 to-pink-600/40 border border-${accentColor}-500/50`
                            : `bg-${accentColor}-500/10 hover:bg-${accentColor}-500/20 border border-transparent`
                        }`
                      },
                        h('p', { className: 'font-medium truncate' }, track.name),
                        h('p', { className: `text-xs text-${accentColor}-300/70` }, 'Unknown Artist')
                      )
                    )
                  )
            )
          )
        ),
        h('input', {
          ref: fileInputRef,
          type: 'file',
          accept: 'audio/*',
          multiple: true,
          onChange: handleFileUpload,
          className: 'hidden'
        }),
        h('audio', { ref: audioRef, src: currentTrack?.url }),
        h('audio', { ref: nextAudioRef })
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('app'));
    root.render(React.createElement(NebulaMusicPlayer));
  </script>
</body>
</html>